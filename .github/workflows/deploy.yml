name: Deploy to Vercel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Cache Node.js modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: |
          echo "Installing dependencies with compatibility fixes..."
          npm install --legacy-peer-deps || echo "Retrying npm install..."

          # Downgrade React and React-DOM to v18
          echo "Ensuring React and React-DOM are at v18..."
          npm install react@18 react-dom@18 --legacy-peer-deps

          # Install react-lazyload (correct version)
          if ! npm list react-lazyload >/dev/null 2>&1; then
            echo "Installing react-lazyload@3.2.0..."
            npm install react-lazyload@3.2.0 --legacy-peer-deps
          fi

          # Install @react-three/drei
          if ! npm list @react-three/drei >/dev/null 2>&1; then
            echo "Installing @react-three/drei..."
            npm install @react-three/drei --legacy-peer-deps
          fi

          # Debug final dependency tree
          echo "Final dependency tree:"
          npm ls
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_KEY }}

      - name: Validate environment variables
        run: |
          if [ -z "${NEXT_PUBLIC_SUPABASE_URL}" ] || [ -z "${NEXT_PUBLIC_SUPABASE_ANON_KEY}" ]; then
            echo "Environment variables are missing!"
            exit 1
          fi

      - name: Configure ESLint for Next.js
        run: |
          echo "Installing and configuring ESLint for Next.js..."
          npm install eslint-plugin-next --legacy-peer-deps --save-dev
          echo '{
            "extends": ["next/core-web-vitals"]
          }' > .eslintrc.json

      - name: Clear cached build files
        run: |
          echo "Clearing cached build files..."
          rm -rf .next

      - name: Build the application
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_KEY }}
        run: npm run build

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          echo "Deploying to Vercel..."
          npx vercel --prod --yes --token=$VERCEL_TOKEN
